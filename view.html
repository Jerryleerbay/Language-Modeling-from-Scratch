<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>View</title>
</head>
<body>
    <div id="content"></div>

    <script>
        let numExistingElements = 0;  // Always growing
        let numAddedElements = 0;  // Reset to 0 after each reload

        function reload() {
            // Remove old script element if it exists
            const oldScript = document.getElementById("script");
            if (oldScript) {
                document.head.removeChild(oldScript);
            }

            // Create a new script element
            const script = document.createElement("script");
            script.id = "script";
            script.type = "text/javascript";
            script.src = "content.js?" + new Date().getTime(); // Append timestamp to avoid caching
            document.head.appendChild(script);
            numAddedElements = 0;
        }

        // Functions that the script can call
        function addText(stack, text, style) {
            numAddedElements += 1;
            if (numAddedElements < numExistingElements) {
                return;
            }
            numExistingElements += 1;

            const content = document.getElementById("content");
            const div = document.createElement("div");

            const prefixSpan = document.createElement("span");
            const prefix = stack.join(" / ") + ": ";
            prefixSpan.appendChild(document.createTextNode(prefix));
            prefixSpan.style.color = "gray";
            div.appendChild(prefixSpan);

            const textSpan = document.createElement("span");
            setStyle(textSpan, style);
            if (isUrl(text)) {
                const link = document.createElement("a");
                link.href = text;
                link.target = "_blank";
                link.appendChild(document.createTextNode(text));
                textSpan.appendChild(link);
            } else {
                textSpan.appendChild(document.createTextNode(text));
            }
            div.appendChild(textSpan);

            content.appendChild(div);
        }

        function addImage(stack, path, style) {
            numAddedElements += 1;
            if (numAddedElements < numExistingElements) {
                return;
            }
            numExistingElements += 1;

            const content = document.getElementById("content");

            const image = document.createElement("img");
            // Append a unique query string to the image src URL to bypass the cache
            image.src = path + "?" + new Date().getTime();
            setStyle(image, style);
            content.appendChild(image);
        }

        function setStyle(elem, style) {
            if (style) {
                for (const key in style) {
                    elem.style[key] = style[key];
                }
            }
        }

        function isUrl(text) {
            return text.startsWith("http://") || text.startsWith("https://");
        }

        setInterval(reload, 1000);
    </script>
</body>
</html>
